# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Tailscale Dev DNS is a bash-based automation tool that configures a Mac as a DNS server for local development domains accessible across a Tailscale VPN. It enables accessing local dev domains (e.g., `*.local.dev`) from any device (iPhone, iPad, Android, etc.) anywhere in the world using Tailscale's encrypted network.

## Core Components

### Configuration System
- **`.env`** - User configuration file (generated by interactive wizard or copied from `.env.example`)
  - `DOMAIN_PATTERN` - Regex to match domains from /etc/hosts
  - `HOST_IP_PATTERN` - Regex to match source IPs in /etc/hosts
  - `CERT_DOMAINS` - Space-separated domains for certificate generation
  - `CERT_EXPORT_DIR` - Where to export certificates (default: `./certs`)

### Scripts Architecture (`scripts/`)

**`configure-interactive.sh`** - Smart configuration wizard that:
- Scans `/etc/hosts` for local development domains
- Auto-detects domain patterns (.dev, .local.dev, etc.)
- Suggests optimal regex patterns based on discovered domains
- Creates `.env` file with validated configuration
- Runs setup script after configuration

**`setup-tailscale-dns.sh`** - Main setup script that:
- Validates and loads configuration from `.env` (falls back to defaults)
- Installs/configures Tailscale (verifies connection)
- Installs/configures dnsmasq as DNS server
- Generates HTTPS certificates with mkcert
- Creates project-local config directory (`config/`) containing:
  - `dnsmasq-tailscale.conf` - dnsmasq-specific configuration
  - `hosts` - Tailscale-specific hosts file (generated from /etc/hosts)
  - `update-hosts.sh` - Script to regenerate hosts file
  - `updater.out` / `updater.err` - LaunchAgent logs
- Sets up LaunchAgent to watch `/etc/hosts` for changes and auto-sync
- Exports CA certificate to `./certs/rootCA.crt` for device installation

**`cleanup-tailscale-dns.sh`** - Cleanup script with two modes:
1. Remove configuration only (keeps dnsmasq installed)
2. Remove all (uninstall dnsmasq + remove certs + remove config)
- Creates backups in `$HOME/proxy-certs/backups/` before cleanup
- Removes LaunchAgent and project config directory
- Optionally removes `.env` file

### System Integration

**dnsmasq Configuration:**
- Main config: `/opt/homebrew/etc/dnsmasq.conf`
- Managed by Homebrew services: `brew services start/stop/restart dnsmasq`
- Listens on: localhost, LAN IPs, and Tailscale IP
- References project-local config via `conf-file=` directive
- Uses `addn-hosts=` to point to generated hosts file

**LaunchAgent:**
- Location: `~/Library/LaunchAgents/com.localdev.dnsmasq-hosts-updater.plist`
- Watches `/etc/hosts` using `WatchPaths` key
- Runs `config/update-hosts.sh` when /etc/hosts changes
- Restarts dnsmasq automatically after hosts update

## Development Commands

### Primary Commands (via Makefile)
```bash
make setup      # Smart setup (interactive if no .env, else uses existing config)
make config     # Run interactive configuration wizard (create/update .env)
make cleanup    # Remove configuration (interactive: config only or full removal)
make status     # Show Tailscale, dnsmasq, and certificate status
make test       # Test DNS resolution (checks dnsmasq running, shows Tailscale IP)
```

### Advanced Commands
```bash
make restart      # Restart dnsmasq service (requires sudo)
make logs         # Show dnsmasq logs
make show-config  # Display current .env settings
make share-cert   # Open ./certs folder for sharing CA certificate
```

### Aliases
- `make install` / `make start` → `make setup`
- `make configure` → `make config`
- `make uninstall` → `make cleanup`

## Development Workflow

### Testing Configuration Changes
1. Modify `.env` file with new patterns
2. Run `make setup` to apply changes
3. Use `make test` to verify dnsmasq is running
4. Test from another Tailscale device: `ping yourdomain.dev`

### Debugging DNS Issues
- Check dnsmasq status: `make status`
- View dnsmasq logs: `make logs`
- Test local resolution: `dig @$(tailscale ip -4) yourdomain.dev`
- Check generated hosts: `cat config/hosts`
- Verify LaunchAgent: `launchctl list | grep dnsmasq`

### Certificate Management
- Certificates stored in `./certs/` directory
- `rootCA.crt` / `rootCA.pem` - CA certificate for device installation
- `cert.pem` / `key.pem` - Symlinks to generated certificates
- Regenerate: Delete `./certs` and run `make setup`

## Important Implementation Details

### Regex Pattern Validation
Both `DOMAIN_PATTERN` and `HOST_IP_PATTERN` are validated at runtime by testing against sample inputs. Invalid patterns trigger warnings but don't block setup.

### Configuration Precedence
1. `.env` file in repo root (if exists)
2. Environment variables (if set)
3. Hardcoded defaults in script

### Backwards Compatibility
The cleanup script removes old configuration files from previous versions:
- `/opt/homebrew/etc/dnsmasq-tailscale-hosts` (legacy)
- `/opt/homebrew/etc/update-dnsmasq-hosts.sh` (legacy)
- `/opt/homebrew/etc/dnsmasq-tailscale.conf` (legacy)

Current version stores everything in project-local `config/` directory.

### Tailscale Command Detection
Scripts support both:
- CLI tool: `tailscale` (installed via Homebrew)
- GUI app: `/Applications/Tailscale.app/Contents/MacOS/Tailscale`

Detection logic prioritizes CLI, falls back to GUI app bundle.

## Key Technical Decisions

### Why Project-Local Config Directory?
Previous versions stored config in `/opt/homebrew/etc/`. Current version uses `config/` in the repo to:
- Keep all project files together
- Make cleanup easier (single directory removal)
- Avoid cluttering system directories
- Enable multiple installations (different repos)

### Why LaunchAgent vs LaunchDaemon?
Uses LaunchAgent (user-level) instead of LaunchDaemon (system-level) because:
- No sudo required for management
- Runs in user context (can access user's Tailscale)
- Easier to debug (stdout/stderr logged to project folder)

### Why Separate Hosts File?
dnsmasq is configured with `no-hosts` and uses `addn-hosts=` pointing to generated hosts file because:
- Avoids modifying system `/etc/hosts`
- Allows filtering by IP and domain patterns
- Enables IP rewriting (localhost → Tailscale IP)
- Simplifies updates (regenerate file, restart dnsmasq)
